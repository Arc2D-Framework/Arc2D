(()=> {
  function toAbsoluteURL(url) {
    const a = document.createElement("a");
    a.setAttribute("href", url);    // <a href="hoge.html">
    return a.cloneNode(false).href; // -> "http://example.com/hoge.html"
  }

  function importModule(url) {
    return new Promise((resolve, reject) => {
      const vector = "$importModule$" + Math.random().toString(32).slice(2);
      const script = document.createElement("script");
      const destructor = () => {
        delete window[vector];
        script.onerror = null;
        script.onload = null;
        script.remove();
        URL.revokeObjectURL(script.src);
        script.src = "";
      };
      script.defer = "defer";
      script.type = "module";
      script.onerror = async () => {
        // reject(new Error(`Failed to import: ${url}`));
        console.error(`Failed to import: ${url}`, "Trying window.imports()")
        try{
          var r = await window.imports(url)
          resolve(r);
        } catch(e) {
          reject(new Error(`Failed to import: ${url}`));
        }
        
      };
      script.onload = () => {
        resolve(window[vector]);
        destructor();
      };
      const absURL = toAbsoluteURL(url);
      const loader = `import * as m from "${absURL}"; window.${vector} = m;`; // export Module
      const blob = new Blob([loader], { type: "text/javascript" });
      script.src = URL.createObjectURL(blob);

      document.head.appendChild(script);
    });
  }

  window.importModule = importModule;
  window.require = importModule;
  
  // function supportsDynamicImport() {
  //   try {
  //     new Function('import("")');
  //     return true;
  //   } catch (err) {
  //     return false;
  //   }
  // }

  // if(!supportsDynamicImport()){
  //   window.require = importModule;
  // }

})();

// export default importModule;
