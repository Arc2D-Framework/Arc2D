/*
 MIT
*/
'use strict';var Session=Session||{State:{}};var Config=window.Config||{SRC_PATH:"src/",ENVIRONMENT:"prod",ROOTPATH:"./",LOGGING:true,DYNAMICLOAD:true,FILENAME:"index.*js",ENABLE_TRANSPILER:true,NAMESPACE:null};if(!String.prototype.toDomElement)String.prototype.toDomElement=function(){var n=document.createRange().createContextualFragment(this.toString());return n.firstElementChild};var wait=(ms)=>new Promise((r,j)=>setTimeout(r,ms));window.registered_tags=window.registered_tags||{};
if(Config.LOGGING==false)for(var k in console)console[k]=function(){};window.getParameterByName=function(name,url){var match=RegExp("[?&]"+name+"=([^&]*)").exec(url||window.location.href);return match&&decodeURIComponent(match[1].replace(/\+/g," "))};window.toAbsoluteURL=function(url){const a=document.createElement("a");a.setAttribute("href",url);return a.cloneNode(false).href};window.classof=function(ns){return NSRegistry[ns]};window.imported_classes=window.imported_classes||{};
window.imports=async function(x,opts,isError){opts=opts||{cache:Config.IMPORTS_CACHE_POLICY||"no-store"};return new Promise(async(resolve,reject)=>{var path=x;path=path.replace(/^\/+/,Config.ROOTPATH);var error="404 import: "+toAbsoluteURL(path)||path;if(window.imported_classes[x]){resolve(window.imported_classes[x]);return}try{const response=await fetch(path,opts);if(response.ok){const res=await response.text().then((src)=>{window.imported_classes[x]=src;resolve(src)})}else{var src=await response.text();
console.error(error);resolve(null)}}catch(e){try{var request=new XMLHttpRequest;request.open("GET",path,false);request.send(null)}catch(xe){console.error("404 import: "+toAbsoluteURL(path),xe);resolve("")}if(request.status==0||request.status==200){src=request.responseText;window.imported_classes[x]=src;resolve(src)}}})};
window.Key={_pressed:{},LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",A:"KeyA",D:"KeyD",isDown:function(code){return this._pressed[code]},onKeydown:function(e){this._pressed[e.code]=true},onKeyup:function(e){delete this._pressed[e.code]}};window.addEventListener("keyup",function(e){Key.onKeyup(e)},false);window.addEventListener("keydown",function(e){Key.onKeydown(e)},false);function transpile(target,level){}
function relativeToAbsoluteFilePath(path,ns,appendRoot){ns=ns||this.namespace;ns=ns.replace(/\./gim,"/");if(path.indexOf("/./")>=0)path=path.replace("./",ns+"/");path=/http:/.test(path)?path:path.replace("//","/");return path}window.stylesheets=function stylesheets(target,paths){paths&&paths.forEach((p)=>{var filepath=relativeToAbsoluteFilePath(p,target.prototype.namespace,false);target.prototype["@stylesheets"]=target.prototype["@stylesheets"]||[];target.prototype["@stylesheets"].push(filepath)})};
window.traits=function traits(target,__traits){for(let mixin of __traits)copy(target.prototype,mixin.prototype);function copy(target,source){for(let key of Reflect.ownKeys(source))if(!/constructor|namespace|ancestor|classname|prototype|name/.test(key)){let desc=Object.getOwnPropertyDescriptor(source,key);Object.defineProperty(target,key,desc)}}};window.cascade=function cascade(target,shouldCascade){target.prototype["@cascade"]=shouldCascade};
window.prop=function prop(target,key,val){target.prototype[key]=val};window.tag=function tag(target,name){target.prototype["ns-tagname"]=name;try{window.customElements.define(name,target)}catch(e){}return};window.field=function field(target,type,key,val){target=type=="static"?target:target.prototype;target[key]=val};
(function(env){env.NSRegistry=env.NSRegistry||{};env.namespace=function(ns){ns=ns[0];return function(...defs){defs.forEach((def)=>{def=def||{};var nsparts=ns.match(/\.([A-Z]+[a-zA-Z0-9_]*)\b$/);var k=def.prototype||def;k.classname=nsparts?nsparts[1]:def.name;var fns=ns+"."+k.classname;k.namespace=fns;return env.NSRegistry[fns]=typeof def=="function"?createNS(fns,createClass(def||{})):createNS(ns,def||{}),delete def.namespace,delete def.classname})}};var createNS=function(aNamespace,def){var parts=
aNamespace.split(/\./g);var classname=parts.pop();var scope=parts.reduce((acc,next)=>acc[next]?acc[next]:acc[next]={},env);scope[classname]=def;return scope[classname]};var createClass=function(func){try{var proto=func.prototype;proto.ancestor=proto.__proto__.constructor;try{func.define(proto)}catch(e){}return func}catch(e){return func}return func}})(typeof window!="undefined"?window:global);
namespace`core.ui.templating`(class CustomTemplateEngines{constructor(){this.engines={};this.defaultMimetype=Config.DEFAULT_TEMPLATE_ENGINE_MIMETYPE||"template/literals"}define(mimeType,engine){if(!this.engines[mimeType]){this.engines[mimeType]=engine;engine.install()}}getEngineByMimeType(mime){return this.engines[mime]}get default(){return this.engines[this.defaultMimetype]}set default(mimeType){this.defaultMimetype=mimeType}});window.customTemplateEngines=new core.ui.templating.CustomTemplateEngines;
(()=>{var TemplateLiterals={name:"TemplateLiterals",ext:"",parse:function(tempStr,data,self){var parse=(tempStr,templateVars)=>{return(new Function("return `"+tempStr+"`;")).call(templateVars)};return parse(tempStr,data)},install:function(){}};window.customTemplateEngines.define("template/literals",TemplateLiterals)})();
namespace`w3c.ui`(class WebComponent extends HTMLElement{constructor(el){super();this.element=el;this.__proto=this.constructor.prototype;this.root=this.onEnableShadow()?this.attachShadow({mode:"open"}):this.element||this;if(this.element)this.decorate()}getDefaultStyleSheet(){return relativeToAbsoluteFilePath("/src/./index.css",this.namespace)}static define(proto,bool){var tag=proto.classname.replace(/([a-zA-Z])(?=[A-Z0-9])/g,(f,m)=>`${m}-`).toLowerCase();if(/\-/.test(tag)){proto["ns-tagname"]=tag;
this.defineAncestors();this.defineAncestralClassList();try{window.customElements&&window.customElements.define(tag,this)}catch(e){console.error(e)}}}setStylesheet(){var css=this.cssStyle();!!css&&!this.__proto._style_defined?(this.onAppendStyle(`<style type="text/css" rel="stylsheet">\n${css}\n</style>`.toDomElement()),this.__proto._style_defined=true):null}querySelector(cssSel,e){if(e)return this.getParentNodeFromEvent(e,cssSel);else return this.onEnableShadow()||this.element?this.root.querySelector(cssSel):
super.querySelector(cssSel)}querySelectorAll(cssSel,deep){return this.onEnableShadow()||this.element?this.root.querySelectorAll(cssSel):super.querySelectorAll(cssSel)}onAppendStyle(stylesheet){if(this.onEnableShadow())try{var style=new CSSStyleSheet;style.replace(stylesheet.innerText);this.root.adoptedStyleSheets=[stylesheet];this.onStyleComputed(stylesheet)}catch(e){console.error(`${e.message} Unable to adopt stylesheet \n                        into shadow dom -- ${this.namespace}#onAppendStyle(), \n                        see: https://bugzilla.mozilla.org/show_bug.cgi?id=1520690.\n                        As a workaround, @import the css from within <template>`)}else{var headNode=
application.head;var configscript=application.configscript;headNode.insertBefore(stylesheet,configscript);this.onStyleComputed(stylesheet)}}onStyleComputed(stylesheet){}adopts(orphan){orphan&&orphan.parentNode.replaceChild(this,orphan);orphan&&this.appendChild(orphan)}replaces(orphan){orphan&&orphan.parentNode.replaceChild(this,orphan)}dispatchEvent(type,data,details={bubbles:true,cancelable:true,composed:true},element=this){var evt=new CustomEvent(type,details);evt.data=data;return super.dispatchEvent(evt)}bind(el,
evtName,handler,bool=false){var self=this;if(typeof el=="string")this.addEventListener(evtName,(e)=>{var t=this.getParentNodeFromEvent(e,el);if(t)handler({target:t,realtarget:e.target,src:e,preventDefault:()=>e.preventDefault,stopPropagation:()=>e.stopPropagation})},bool);else el.addEventListener(evtName,handler,bool)}getParentBySelectorUntil(elem=this,terminator="html",selector){var parent_node=null;do{if(elem.matches(selector)){parent_node=elem;break}if(elem.matches(terminator))break;elem=elem.parentNode}while(elem&&
elem.matches);return parent_node}getParentNodeFromEvent(e,selector,terminator){var el=e.composedPath()[0];return this.getParentBySelectorUntil(el,terminator,selector)}onStylesheetLoaded(style){}onTransformStyle(css){return css}setCssTextAttribute(_cssText,stylenode){if(stylenode&&stylenode.styleSheet)stylenode.styleSheet.cssText=_cssText;else stylenode.appendChild(document.createTextNode(_cssText))}async loadTemplate(){return new Promise(async(resolve,reject)=>{var tem=this.getTemplateToLoad();if(/\/*\.html$/.test(tem)){var src=
this.src||tem;var opts={cache:"force-cache"};src=src.replace("/./","/"+this.namespace.replace(/\./gim,"/")+"/");this._template=await imports(src,opts)}else if(/<\s*\btemplate\b/.test(tem))this._template=tem;else if(tem&&tem.nodeType==1)this._template=tem.outerHTML;resolve(this._template)})}getTemplateToLoad(){var engine=this.getTemplateEngine();return this.querySelector("template")||this.src||this.template()||"/src/./index"+(engine.ext||"")+".html"}onConnected(data){this.render(data)}onPreConnected(){this.onConnected()}render(data){if(this.element)return;
data=data||{};data.component=this;var t=this._template;if(t){var html=this.evalTemplate(t,data||{});var temNode=html.toDomElement();temNode=temNode.content;if(!this.onEnableShadow())this.slots.forEach((slot)=>{var slotName=slot.getAttribute("slot");var placeholder=temNode.querySelector(`slot[name="${slotName}"]`);if(placeholder)if(!placeholder.hasAttribute("append"))placeholder.innerHTML="";(placeholder||temNode).appendChild(slot)});this.root.innerHTML="";this.root.appendChild(temNode);this.onTemplateRendered(temNode)}}async connectedCallback(){if(this._is_connected)return;
this._is_connected=true;var html=await this.loadTemplate();this.onTemplateLoaded()}decorate(){this.setClassList();this.setPrototypeInstance();this.setStyleDocuments();this.onPreConnected()}onTemplateLoaded(){this.slots=this.getSlots();this.setClassList();this.setPrototypeInstance();this.setStyleDocuments();this.onPreConnected()}getSlots(){return Array.from(this.children)}onTemplateRendered(){this.initializeChildComponents()}static get observedAttributes(){return["src"]}get src(){return this.getAttribute("src")}set src(val){this.setAttribute("src",
val)}onEnableShadow(){return this.hasAttribute("shadow")}attachShadow(options){this._usesShadow=true;return super.attachShadow(options)}async attributeChangedCallback(name,oldValue,newValue){if(name=="src")if(!this._is_connected)return;else{var html=await this.loadTemplate();this.onPreConnected()}}cssStyle(){return""}setStyleDocuments(){this.loadcss(this.getStyleSheets());if(this.onLoadInstanceStylesheet())this.loadcss([this.getDefaultStyleSheet()]);this.setStylesheet()}onLoadInstanceStylesheet(){return true}static defineAncestors(){this.ancestors=
[];var a=this;while(a&&this.ancestors.push(a))a=a.prototype.ancestor}static defineAncestralClassList(){this.prototype.classes=[];for(let ancestor of this.ancestors){var proto=ancestor.prototype;if(proto["@cascade"]||ancestor==this)this.prototype.classes.unshift(proto.classname);else break}}setClassList(){this.root.className+=this.className+(" "+this.constructor.prototype.classes.join(" ")).trim()}getStyleSheets(){var styles=this["@stylesheets"]||[];return styles.reverse()}async loadcss(urls){urls=
urls.reverse();var stylesheets=window.loaded_stylesheets=window.loaded_stylesheets||{};for(let path of urls){path=this.onLoadStyle(path);if(path&&!stylesheets[path]){var tagName=/^http/.test(path)?"link":"style";var tag=document.createElement(tagName);tag.setAttribute("type","text/css");tag.setAttribute("rel","stylesheet");tag.setAttribute("href",path);tag.setAttribute("component",this.namespace);stylesheets[path]=tag;if(tagName.toLowerCase()=="style"){var _cssText=await window.imports(path);if(_cssText){_cssText=
this.onTransformStyle(_cssText);_cssText&&this.setCssTextAttribute(_cssText,tag);this.onStylesheetLoaded(tag);this.onAppendStyle(tag)}}else this.onAppendStyle(tag)}}}onLoadStyle(url){return url}template(){return null}evalTemplate(template,data){var eng=this.getTemplateEngine();return eng.parse(template,data,this)}getTemplateEngine(){return window.customTemplateEngines.default}setPrototypeInstance(){this.root.setAttribute("namespace",this.namespace);this.prototype=this}resourcepath(url,ns){url=url.replace(/\$\{ns\}/gm,
ns.replace(/\./gim,"/"));return Config.ROOTPATH+url}initializeChildComponents(el){el=el||this;var self=this;var nodes=this.querySelectorAll("*");nodes=[].slice.call(nodes);nodes.forEach((n)=>{if(n&&n.nodeType==1){var tag=n.tagName.toLowerCase();var c=window.registered_tags[tag];c&&c.define(c.prototype,true)}})}isAnyPartOfElementInViewport(el=this){var rect=el.getBoundingClientRect();var v=rect.top<=window.innerHeight&&rect.bottom>=0;var h=rect.left<=window.innerWidth&&rect.right>=0;return v&&h}});
cascade(w3c.ui.WebComponent,true);
namespace`w3c.ui`(class Application extends w3c.ui.WebComponent{constructor(){super();window.application=this;window.sprites=[];this.head=document.getElementsByTagName("head")[0];this.configscript=document.querySelector("script[id='config']")||document.querySelector("script")}onUpdate(time){window.sprites.forEach((sprite)=>sprite.onUpdate(time))}onDraw(interpolation){if(this.context)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);window.sprites.forEach((sprite)=>sprite.onDraw(interpolation,
this.context))}onEnd(fps,panic){if(panic){var discardedTime=Math.round(MainLoop.resetFrameDelta());console.warn("Main loop panicked, probably because the browser tab was put in the background. Discarding "+discardedTime+"ms")}}static define(proto,bool=true){super.define(proto,bool)}onConnected(){this.render()}});function Ecmascript6ClassTranspiler(){}Ecmascript6ClassTranspiler.prototype.imports=window.imports;
Ecmascript6ClassTranspiler.prototype.transpile=function(src,doc){var doTranspile=Config.ENABLE_TRANSPILER;if(doTranspile){src=this.transpileToLevel(src);return src}else return src};
Ecmascript6ClassTranspiler.prototype.transpileToLevel=function(src){var nsReg=/namespace\s?`([^\s`]*)/;var clsReg=/class\s+([^\s]*)[\s\n\t]?[\{|extends]/;var nsMatch=src.match(nsReg);var classMatch=src.match(clsReg);if(!nsMatch&&!classMatch)return this.transipleImportsDestructuring(src);else{nsMatch=nsMatch?nsMatch[1]:"";classMatch=classMatch?classMatch[1]:"";nsMatch=nsMatch+"."+classMatch;src=this.transipleDecoratorFields(nsMatch,src);src=this.transipleClassFields(nsMatch,src);src=this.transipleImportsDestructuring(src);
return src}};Ecmascript6ClassTranspiler.prototype.transipleDecoratorFields=function(ns,src){var regex=/@([^\W]*)\({1}([^;]*)\){1};{1}/gm;var props=[];if(ns){src=src.replace(regex,(full,method,args)=>{props.push(`${method}(${ns}, ${args});`);return""});var fullsrc=src+"\n"+props.join("\n")}else{src=src.replace(regex,(full,method,args)=>{return""});fullsrc=src}return fullsrc};
Ecmascript6ClassTranspiler.prototype.transipleImportsDestructuring=function(src){var regex=/import\s\{([^\}]*)\}\sfrom\s([^;]*)/gm;src=src.replace(regex,(full,destructured_var,src_path)=>{destructured_var=destructured_var.replace(/\s+as\s+/gm,":");return`var {${destructured_var}} = (()=> {\nimport ${src_path};\n})();`});src=src.replace("export","return");return src};
Ecmascript6ClassTranspiler.prototype.transipleClassFields=function(ns,src){var regex=new RegExp(/(@static|@public|@private)\s+([^\s]*)\s+=([^;]*);/gm);var props=[];if(ns){src=src.replace(regex,(full,type,name,val)=>{type=type.replace("@","");props.push(`field(${ns}, "${type}", "${name}", ${val});`);return""});var fullsrc=src+"\n"+props.join("\n")}else{src=src.replace(regex,(full,type,name,val)=>{return""});fullsrc=src}return fullsrc};namespace`core.http`(class ResourceLoader{constructor(){return this}});
namespace`core.http`(class ClassLoader extends core.http.ResourceLoader{constructor(){super();this.es6Transpiler=new Ecmascript6ClassTranspiler;window.run=this.run.bind(this);return this}run(src,cb){this.build(src,(output)=>{var head=document.getElementsByTagName("head").item(0);var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("charset",Config.CHARSET||"utf-8");script.text=output;head.appendChild(script);cb(script)})}async load(_namespace,
filepath,cb){var self=this;var self=this;var src;var cfFailure=function(src,xhr){cb?cb(xhr):null};var src;if(filepath)src=await window.imports(filepath);src?this.run(src,cb):cfFailure(src,"no xhr")}async build(src,cb){src=this.es6Transpiler.transpile(src);var reg=/^import\s+['"]{1}([^'"]*)['"]{1};?/m;while(reg.test(src)){var ns_or_path=src.match(reg)[1];var s=(window.imported_classes[ns_or_path]?";":await this.imports(ns_or_path))||"";s=s?this.es6Transpiler.transpile(s):"";src=src.replace(reg,s)}src=
`(()=>{ ${src} })()`;cb(src)}async imports(ns){var paths_to_try=this.pathsToTry(ns);for(let path of paths_to_try){var code=await window.imports(path);if(code)return code}}pathsToTry(ns){if(/\.m?js$/.test(ns))return[ns];var srcpath=Config.SRC_PATH;var paths=[];paths.push(srcpath+ns.replace(/\./gm,"/")+"/index.js");paths.push(srcpath+ns.replace(/\./gm,"/")+"/index.min.js");paths.push(srcpath+ns.replace(/\./gm,"/")+".js");return paths}});
namespace`core.http`(class ModuleLoader extends core.http.ResourceLoader{constructor(){super();return this}load(ns,filepath,cb){var head=document.getElementsByTagName("head").item(0);var script=document.createElement("script");script.setAttribute("type","module");script.setAttribute("charset",Config.CHARSET||"utf-8");script.src=filepath;head.appendChild(script);cb?cb(script):null}});
!function(a){function b(a){if(x=q(b),!(a<e+l)){for(d+=a-e,e=a,t(a,d),a>i+h&&(f=g*j*1E3/(a-i)+(1-g)*f,i=a,j=0),j++,k=0;d>=c;)if(u(c),d-=c,++k>=240){o=!0;break}v(d/c),w(f,o),o=!1}}var c=1E3/60,d=0,e=0,f=60,g=.9,h=1E3,i=0,j=0,k=0,l=0,m=!1,n=!1,o=!1,p="object"==typeof window?window:a,q=p.requestAnimationFrame||function(){var a=Date.now(),b,d;return function(e){return b=Date.now(),d=Math.max(0,c-(b-a)),a=b+d,setTimeout(function(){e(b+d)},d)}}(),r=p.cancelAnimationFrame||clearTimeout,s=function(){},t=s,
u=s,v=s,w=s,x;a.MainLoop={getSimulationTimestep:function(){return c},setSimulationTimestep:function(a){return c=a,this},getFPS:function(){return f},getMaxAllowedFPS:function(){return 1E3/l},setMaxAllowedFPS:function(a){return"undefined"==typeof a&&(a=1/0),0===a?this.stop():l=1E3/a,this},resetFrameDelta:function(){var a=d;return d=0,a},setBegin:function(a){return t=a||t,this},setUpdate:function(a){return u=a||u,this},setDraw:function(a){return v=a||v,this},setEnd:function(a){return w=a||w,this},start:function(){return n||
(n=!0,x=q(function(a){v(1),m=!0,e=a,i=a,j=0,x=q(b)})),this},stop:function(){return m=!1,n=!1,r(x),this},isRunning:function(){return m}},"function"==typeof define&&define.amd?define(a.MainLoop):"object"==typeof module&&null!==module&&"object"==typeof module.exports&&(module.exports=a.MainLoop)}(this);
document.addEventListener("DOMContentLoaded",(e)=>{async function bootup(){var ns=document.body.getAttribute("namespace");ns=ns||Config.NAMESPACE;if(Config.DYNAMICLOAD){var filename_path=Config.SRC_PATH+ns.replace(/\./g,"/")+"/"+Config.FILENAME;var path=filename_path.replace("*",Config.USE_COMPRESSED_BUILD?"min.":"");var c=Config.ENABLE_TRANSPILER?new core.http.ClassLoader:new core.http.ModuleLoader;c.load(ns,Config.ROOTPATH+path,(res)=>{var app=window.application;MainLoop.setUpdate(app.onUpdate.bind(app)).setDraw(app.onDraw.bind(app)).setEnd(app.onEnd.bind(app)).start()})}}
"cordova"in window?document.addEventListener("deviceready",()=>{AndroidFullScreen&&AndroidFullScreen.immersiveMode((e)=>{},(e)=>{});bootup()},false):bootup()},false);
